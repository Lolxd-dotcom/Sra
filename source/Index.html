<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SRA Runtime</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/4.1.0/js-yaml.min.js"></script>
    <style>
        :root { --primary: #38bdf8; --bg: #0f172a; --text: #f8fafc; }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; }
        #sra-root { min-height: 100vh; display: flex; flex-direction: column; }
        
        /* Basic Element Styling */
        .sra-column { display: flex; flex-direction: column; gap: 1rem; padding: 20px; align-items: center; }
        .sra-text { margin: 5px 0; line-height: 1.5; }
        .sra-button { padding: 12px 24px; background: var(--primary); border: none; border-radius: 8px; color: #000; font-weight: bold; cursor: pointer; }
        .sra-clock { font-family: monospace; font-size: 1.5rem; color: var(--primary); }
        img, object { max-width: 100%; border-radius: 8px; }
        
        /* Debug UI */
        #sra-debug-bar { position: fixed; top: 0; width: 100%; background: rgba(0,0,0,0.8); padding: 5px; font-size: 10px; color: #ccc; z-index: 999; display: none; }
    </style>
</head>
<body>
    <div id="sra-debug-bar">SRA Engine Active</div>
    <div id="sra-root"></div>

    <script>
        const root = document.getElementById('sra-root');
        const debugBar = document.getElementById('sra-debug-bar');

        const SRA_HANDLERS = {
            'background': (el) => {
                if (el.getAttribute('color')) document.body.style.backgroundColor = el.getAttribute('color');
                if (el.getAttribute('textColor')) document.body.style.color = el.getAttribute('textColor');
            },
            'column': () => {
                const div = document.createElement('div');
                div.className = 'sra-column';
                return div;
            },
            'text': (el) => {
                const p = document.createElement('p');
                p.className = 'sra-text';
                p.textContent = el.getAttribute('value');
                if (el.getAttribute('color')) p.style.color = el.getAttribute('color');
                return p;
            },
            'button': (el) => {
                const btn = document.createElement('button');
                btn.className = 'sra-button';
                btn.textContent = el.getAttribute('text');
                return btn;
            },
            'clock': (el) => {
                const span = document.createElement('span');
                span.className = 'sra-clock';
                const is24h = el.getAttribute('format') === '24h';
                const update = () => {
                    span.textContent = new Date().toLocaleTimeString([], { hour12: !is24h });
                };
                setInterval(update, 1000);
                update();
                return span;
            },
            'image': (el, config) => {
                const src = el.getAttribute('src');
                const fallback = config.sra_engine.paths.imageFallback;
                if (src.endsWith('.svg')) {
                    const obj = document.createElement('object');
                    obj.data = src;
                    obj.type = "image/svg+xml";
                    obj.onerror = () => obj.data = fallback;
                    return obj;
                }
                const img = document.createElement('img');
                img.src = src;
                img.onerror = () => img.src = fallback;
                return img;
            }
        };

        async function init() {
            try {
                // 1. Load Config
                const configResp = await fetch('config.yml');
                const configText = await configResp.text();
                const config = jsyaml.load(configText);

                if (config.sra_engine.debug.enabled) debugBar.style.display = 'block';

                // 2. Determine Target File
                const params = new URLSearchParams(window.location.search);
                let target = (config.sra_engine.render.allowDynamicLoad && params.get('sra')) 
                             ? params.get('sra') 
                             : config.sra_engine.render.entry;

                // 3. Validation and Loading
                await loadSRA(target, config);

            } catch (err) {
                console.error("Critical Boot Error:", err);
            }
        }

        async function loadSRA(filePath, config) {
            try {
                // Check extension
                const isValidExt = config.sra_engine.render.validExtensions.some(ext => filePath.endsWith(ext));
                if (!isValidExt) throw new Error("Invalid Extension");

                const resp = await fetch(filePath);
                if (!resp.ok) throw new Error("File Not Found");

                const xmlText = await resp.text();
                const xmlDoc = new DOMParser().parseFromString(xmlText, "text/xml");

                // Verify Root Tag
                if (xmlDoc.documentElement.tagName !== config.sra_engine.render.requiredRoot) {
                    throw new Error("Invalid SRA Signature");
                }

                render(xmlDoc.documentElement, config);
                debugBar.textContent = `SRA Rendered: ${filePath}`;

            } catch (err) {
                console.warn(`SRA Load Failed [${filePath}]: ${err.message}`);
                // Fallback to 404
                const fallbackResp = await fetch(config.sra_engine.paths.errorFallback);
                const fallbackText = await fallbackResp.text();
                const fallbackDoc = new DOMParser().parseFromString(fallbackText, "text/xml");
                render(fallbackDoc.documentElement, config);
            }
        }

        function render(xmlNode, config) {
            root.innerHTML = '';
            const traverse = (node, parent) => {
                for (let child of node.children) {
                    const handler = SRA_HANDLERS[child.tagName.toLowerCase()];
                    if (handler) {
                        const htmlEl = handler(child, config);
                        if (htmlEl) {
                            parent.appendChild(htmlEl);
                            if (child.children.length > 0) traverse(child, htmlEl);
                        }
                    } else {
                        // Basic support for structural containers like <screen>
                        if (child.children.length > 0) traverse(child, parent);
                    }
                }
            };
            traverse(xmlNode, root);
        }

        init();
    </script>
</body>
</html>
